# 운영 가이드

## 1. 사전 준비 (D-7)

### 1.1 경품 준비
- [ ] 경품 목록 확정
- [ ] 경품 수량 확인 (총 100개 중 경품 개수)
- [ ] 경품 등급별 분류

### 1.2 시스템 준비
- [ ] Supabase 프로젝트 생성 완료
- [ ] Next.js 배포 완료
- [ ] 도메인/URL 확정

---

## 2. 경품 설정 (D-3)

### 2.1 경품 배치 전략
**권장 배치:**
| 등급 | 개수 | 확률 | 예시 경품 |
|------|------|------|----------|
| 1등 | 1개 | 1% | 상품권 10만원 |
| 2등 | 2개 | 2% | 상품권 5만원 |
| 3등 | 5개 | 5% | 상품권 2만원 |
| 4등 | 12개 | 12% | 편의점 상품권 1만원 |
| 5등 | 20개 | 20% | 커피 쿠폰 |
| 꽝 | 60개 | 60% | - |
| **합계** | **100개** | **100%** | |

### 2.2 경품 입력 방법
**방법 1: 관리자 화면에서 직접 입력**
1. `/admin` 접속
2. 경품 관리 메뉴
3. 각 번호별 경품 설정

**방법 2: SQL로 일괄 입력**
```sql
-- Supabase SQL Editor에서 실행
UPDATE prizes SET prize_name = '상품권 10만원', prize_grade = '1등'
WHERE game_id = 'your-game-id' AND slot_number = 42;
-- 나머지 경품도 동일하게...
```

**방법 3: 랜덤 배치 (권장)**
```sql
-- 랜덤하게 경품 배치하는 함수
CREATE OR REPLACE FUNCTION distribute_prizes_randomly(p_game_id UUID)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    v_slots INTEGER[];
    v_idx INTEGER := 1;
BEGIN
    -- 모든 슬롯 번호를 랜덤하게 섞기
    SELECT ARRAY(
        SELECT slot_number FROM prizes
        WHERE game_id = p_game_id
        ORDER BY random()
    ) INTO v_slots;

    -- 1등 (1개)
    UPDATE prizes SET prize_name = '상품권 10만원', prize_grade = '1등'
    WHERE game_id = p_game_id AND slot_number = v_slots[v_idx];
    v_idx := v_idx + 1;

    -- 2등 (2개)
    FOR i IN 1..2 LOOP
        UPDATE prizes SET prize_name = '상품권 5만원', prize_grade = '2등'
        WHERE game_id = p_game_id AND slot_number = v_slots[v_idx];
        v_idx := v_idx + 1;
    END LOOP;

    -- 3등 (5개)
    FOR i IN 1..5 LOOP
        UPDATE prizes SET prize_name = '상품권 2만원', prize_grade = '3등'
        WHERE game_id = p_game_id AND slot_number = v_slots[v_idx];
        v_idx := v_idx + 1;
    END LOOP;

    -- 4등 (12개)
    FOR i IN 1..12 LOOP
        UPDATE prizes SET prize_name = '편의점 상품권', prize_grade = '4등'
        WHERE game_id = p_game_id AND slot_number = v_slots[v_idx];
        v_idx := v_idx + 1;
    END LOOP;

    -- 5등 (20개)
    FOR i IN 1..20 LOOP
        UPDATE prizes SET prize_name = '커피 쿠폰', prize_grade = '5등'
        WHERE game_id = p_game_id AND slot_number = v_slots[v_idx];
        v_idx := v_idx + 1;
    END LOOP;

    -- 나머지는 이미 '꽝'으로 설정되어 있음
END;
$$;

-- 실행
SELECT distribute_prizes_randomly('your-game-id');
```

---

## 3. QR 코드 생성 (D-1)

### 3.1 QR 코드 생성 방법

**방법 1: 온라인 생성기**
- https://www.qr-code-generator.com/
- https://goqr.me/
- URL 입력 후 다운로드

**방법 2: 코드로 생성**
```javascript
// Node.js
const QRCode = require('qrcode');

const url = 'https://your-domain.vercel.app';

// 파일로 저장
QRCode.toFile('qr-code.png', url, {
  width: 400,
  margin: 2,
});

// 또는 터미널에 출력
QRCode.toString(url, { type: 'terminal' }, (err, qr) => {
  console.log(qr);
});
```

### 3.2 QR 코드 준비물
- [ ] 큰 사이즈 인쇄 (A3 이상) - 무대/스크린용
- [ ] 중간 사이즈 (A4) - 테이블 배치용
- [ ] PPT 슬라이드에 삽입

---

## 4. 리허설 (D-1)

### 4.1 테스트 시나리오
1. **접속 테스트**
   - QR 스캔으로 접속
   - 이름 입력 및 참가

2. **뽑기 테스트**
   - 번호 선택 및 뽑기
   - 결과 확인

3. **실시간 동기화 테스트**
   - 2개 이상 기기에서 동시 접속
   - 한 기기에서 뽑으면 다른 기기에 반영되는지 확인

4. **동시성 테스트**
   - 같은 번호 동시 클릭 시 한 명만 성공하는지

5. **관리자 기능 테스트**
   - 게임 상태 변경
   - 모니터링 화면

### 4.2 리허설 후 체크리스트
- [ ] 게임 리셋 실행
- [ ] 모든 뽑기 기록 삭제 확인
- [ ] 경품 배치 재확인

---

## 5. 당일 운영 (D-Day)

### 5.1 게임 시작 전
```
시작 30분 전:
- [ ] 관리자 페이지 접속
- [ ] 게임 상태: 'waiting' 확인
- [ ] QR 코드 스크린에 띄우기

시작 10분 전:
- [ ] 참가자들에게 QR 스캔 안내
- [ ] 이름 입력까지만 진행 (뽑기는 불가)

시작 시점:
- [ ] 게임 상태를 'active'로 변경
- [ ] "뽑기 시작!" 안내
```

### 5.2 게임 진행 중
```
- [ ] 관리자 모니터링 화면으로 현황 확인
- [ ] 당첨자 발생 시 즉시 발표 (선택)
- [ ] 기술 문제 발생 시 대응

문제 상황 대응:
- 접속 안됨: 네트워크 확인, URL 재공유
- 뽑기 안됨: 게임 상태 확인 ('active' 여부)
- 화면 멈춤: 새로고침 안내
```

### 5.3 게임 종료
```
- [ ] 게임 상태를 'ended'로 변경
- [ ] 최종 결과 발표
- [ ] 경품 수령 안내

종료 후:
- [ ] 결과 데이터 다운로드 (CSV/Excel)
- [ ] 스크린샷 저장
```

---

## 6. 진행 스크립트 예시

### 6.1 시작 멘트
```
"자, 이제 기다리던 럭키드로우 시간입니다!

스크린에 보이는 QR 코드를 스캔해주세요.
접속하시면 이름을 입력하는 화면이 나옵니다.
이름을 입력하고 '참가하기'를 눌러주세요.

모두 준비되셨나요?

그럼 지금부터 뽑기를 시작하겠습니다!
원하시는 번호를 클릭해주세요!

참, 한 분당 한 번만 뽑으실 수 있으니 신중하게 선택해주세요~"
```

### 6.2 중간 안내
```
"현재 N명이 참여하셨고, M개의 경품이 남아있습니다!

아직 참여 안하신 분들은 서둘러 주세요~"
```

### 6.3 종료 멘트
```
"모든 분들이 참여하셨네요!

지금부터 당첨자를 발표하겠습니다.

1등에 당첨되신 분은... OOO님입니다! 축하드립니다!
..."
```

---

## 7. 비상 대응 계획

### 7.1 서버 다운
1. Supabase 대시보드에서 상태 확인
2. Vercel 대시보드에서 배포 상태 확인
3. 재배포 또는 수동 개입

### 7.2 네트워크 문제
1. 회장 WiFi 확인
2. 모바일 데이터 사용 안내
3. 예비 핫스팟 준비

### 7.3 데이터 문제
1. 중복 당첨 발생 시: DB 직접 확인 및 수정
2. 뽑기 기록 누락 시: draws 테이블 확인

### 7.4 최악의 경우
- 수동으로 진행 (번호 적힌 종이 뽑기)
- 결과는 나중에 시스템에 반영

---

## 8. 결과 정리

### 8.1 데이터 내보내기
```sql
-- 당첨 결과 조회
SELECT
    d.player_name AS "이름",
    p.slot_number AS "번호",
    p.prize_name AS "경품",
    p.prize_grade AS "등급",
    d.drawn_at AS "뽑은시간"
FROM draws d
JOIN prizes p ON d.prize_id = p.id
WHERE d.game_id = 'your-game-id'
ORDER BY
    CASE p.prize_grade
        WHEN '1등' THEN 1
        WHEN '2등' THEN 2
        WHEN '3등' THEN 3
        WHEN '4등' THEN 4
        WHEN '5등' THEN 5
        ELSE 6
    END,
    d.drawn_at;
```

### 8.2 통계 조회
```sql
-- 참여 통계
SELECT
    COUNT(*) AS "총 참여자",
    COUNT(CASE WHEN p.prize_grade IS NOT NULL THEN 1 END) AS "당첨자",
    COUNT(CASE WHEN p.prize_grade IS NULL THEN 1 END) AS "꽝"
FROM draws d
JOIN prizes p ON d.prize_id = p.id
WHERE d.game_id = 'your-game-id';
```

---

## 9. 체크리스트 요약

### D-7 (1주 전)
- [ ] 경품 목록 확정
- [ ] 시스템 배포 완료

### D-3 (3일 전)
- [ ] 경품 데이터 입력
- [ ] 전체 테스트

### D-1 (전날)
- [ ] QR 코드 생성 및 인쇄
- [ ] 리허설 진행
- [ ] 게임 리셋

### D-Day (당일)
- [ ] 시작 30분 전: 최종 점검
- [ ] 시작: 게임 상태 'active'
- [ ] 진행: 모니터링
- [ ] 종료: 게임 상태 'ended'
- [ ] 결과: 데이터 백업
